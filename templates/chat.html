<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat-by-Aaditya</title>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      height: 100vh;
      background-color: #111b21;
      color: #e9edef;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }
    .sidebar {
      width: 340px;
      background-color: #202c33;
      border-right: 1px solid #222d34;
      display: flex;
      flex-direction: column;
      color: #e9edef;
      overflow-y: auto;
    }
    .sidebar-header {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #222d34;
      font-weight: 600;
      font-size: 1.2em;
      gap: 12px;
      background-color: #2a3942;
      flex-shrink: 0;
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #6bcbef;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.25em;
      color: white;
      user-select: none;
    }
    #userList {
      flex: 1;
      overflow-y: auto;
    }
    .user-item {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      cursor: pointer;
      gap: 12px;
      border-bottom: 1px solid #222d34;
      transition: background-color 0.2s;
    }
    .user-item:hover {
      background-color: #2f3d46;
    }
    .user-item.active {
      background-color: #222d34;
      font-weight: 600;
    }
    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: #008069;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1em;
      color: white;
      user-select: none;
      flex-shrink: 0;
    }
    .user-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .online-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: #25d366;
      flex-shrink: 0;
      margin-left: auto;
    }
    .chat-window {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: #111b21;
      background-image: url('https://web.whatsapp.com/img/bg-chat-tile_7b705cb1c2ef3d06efba.png');
      background-repeat: repeat;
      background-position: center;
      overflow: hidden;
    }
    .chat-header {
      display: flex;
      align-items: center;
      padding: 14px 24px;
      background-color: #2a3942;
      border-bottom: 1px solid #222d34;
      gap: 12px;
      font-weight: 600;
      font-size: 1.2em;
      color: #e9edef;
      flex-shrink: 0;
    }
    .chat-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #6bcbef;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.25em;
      color: white;
      user-select: none;
      flex-shrink: 0;
    }
    #messages {
      flex: 1;
      padding: 20px 40px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 1em;
    }
    .message {
      max-width: 60%;
      padding: 12px 18px;
      border-radius: 10px;
      position: relative;
      word-wrap: break-word;
      font-size: 1em;
      line-height: 1.3;
      user-select: text;
    }
    .outgoing {
      background-color: #005c4b;
      color: #e9edef;
      margin-left: auto;
      border-bottom-right-radius: 2px;
      text-align: right;
    }
    .incoming {
      background-color: #202c33;
      color: #e9edef;
      margin-right: auto;
      border-bottom-left-radius: 2px;
      text-align: left;
    }
    .message .meta {
      font-size: 0.75em;
      color: #b6b9bb;
      margin-top: 6px;
      opacity: 0.8;
      user-select: none;
    }
    .chat-input-area {
      display: flex;
      padding: 14px 24px;
      background-color: #202c33;
      border-top: 1px solid #222d34;
      gap: 10px;
      flex-shrink: 0;
    }
    #messageInput {
      flex: 1;
      padding: 12px 18px;
      border-radius: 24px;
      border: none;
      outline: none;
      font-size: 1em;
      background-color: #2a3942;
      color: #e9edef;
    }
    #messageInput::placeholder {
      color: #888f95;
    }
    #messageInput:focus {
      background-color: #222d34;
    }
    #sendButton {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background-color: #005c4b;
      color: white;
      font-size: 1.3em;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
    }
    #sendButton:hover {
      background-color: #008069;
    }
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      background: #111b21;
    }
    ::-webkit-scrollbar-thumb {
      background: #222d34;
      border-radius: 4px;
    }
    .message.selected {
      outline: 2px solid #ff6b6b;
      background-color: #2a3942 !important;
    }
    #deleteSelectedBtn {
      display: none;
      margin: 10px 40px 0 40px;
      padding: 8px 16px;
      background: #ff6b6b;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      cursor: pointer;
    }
    #deleteSelectedBtn.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="avatar" id="myAvatar"></div>
        <span id="myUsername"></span>
        <a href="/logout" id="logoutBtn" title="Logout" style="margin-left:auto;display:flex;align-items:center;">
          <!-- Cool logout SVG icon -->
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" style="display:block;" xmlns="http://www.w3.org/2000/svg">
            <rect x="2" y="4" width="12" height="16" rx="2" fill="#202c33" stroke="#ff6b6b" stroke-width="2"/>
            <path d="M16 12h4m0 0l-2-2m2 2l-2 2" stroke="#ff6b6b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
      </div>
      <div id="userList"></div>
    </div>
    <div class="chat-window">
      <div class="chat-header">
        <div class="chat-avatar" id="chatAvatar">?</div>
        <div id="chatWith">Select a user to chat</div>
      </div>
      <button id="deleteSelectedBtn">Delete Selected</button>
      <div id="messages"></div>
      <div class="chat-input-area" id="chatInputArea" style="display:none;">
        <input id="messageInput" placeholder="Type a message..." autocomplete="off" />
        <button id="sendButton" title="Send message">&#10148;</button>
      </div>
    </div>
  </div>

  <script>
    const socket = io();
    const username = "{{ username }}";  // Flask template variable

    let currentChatUser = null;

    // Initialize UI
    document.getElementById("myUsername").textContent = username;
    document.getElementById("myAvatar").textContent = username[0].toUpperCase();

    // Join the chat room with username
    socket.emit('join', username);

    // Receive the list of users from server
    socket.on('users', users => {
      updateUserList(users);
    });

    // Listen for incoming private messages
    socket.on('private_message', data => {
      if (data.from === currentChatUser || data.from === username || data.to === currentChatUser) {
        addMessageToChat(data.from, data.message, data.time, data.read);
      }
    });

    // --- Message selection and deletion logic ---
    let selectedMessages = new Set();

    function addMessageToChat(from, message, time, read) {
      const messagesEl = document.getElementById("messages");
      const msgDiv = document.createElement("div");
      const isOutgoing = from === username;
      msgDiv.classList.add("message");
      msgDiv.classList.add(isOutgoing ? "outgoing" : "incoming");
      msgDiv.dataset.time = time || "";
      msgDiv.dataset.from = from;
      // Only allow selection for outgoing messages
      if (isOutgoing) {
        msgDiv.addEventListener("click", function (e) {
          // Prevent selecting when clicking links or text selection
          if (window.getSelection().toString()) return;
          msgDiv.classList.toggle("selected");
          if (msgDiv.classList.contains("selected")) {
            selectedMessages.add(msgDiv.dataset.time);
          } else {
            selectedMessages.delete(msgDiv.dataset.time);
          }
          updateDeleteBtn();
        });
      }
      msgDiv.innerHTML = `
        <div>${escapeHtml(message)}</div>
        <div class="meta">
          ${time || ''}
        </div>
      `;
      messagesEl.appendChild(msgDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function updateDeleteBtn() {
      const btn = document.getElementById("deleteSelectedBtn");
      if (selectedMessages.size > 0) {
        btn.classList.add("active");
      } else {
        btn.classList.remove("active");
      }
    }

    document.getElementById("deleteSelectedBtn").addEventListener("click", function () {
      if (!currentChatUser || selectedMessages.size === 0) return;
      if (!confirm("Delete selected messages?")) return;
      socket.emit('delete_messages', {
        from: username,
        to: currentChatUser,
        timestamps: Array.from(selectedMessages)
      });
      selectedMessages.clear();
      updateDeleteBtn();
    });

    // Helper to add a message to chat window
    function addMessageToChat(from, message, time, read) {
      const messagesEl = document.getElementById("messages");
      const msgDiv = document.createElement("div");
      const isOutgoing = from === username;
      msgDiv.classList.add("message");
      msgDiv.classList.add(isOutgoing ? "outgoing" : "incoming");
      msgDiv.innerHTML = `
        <div>${escapeHtml(message)}</div>
        <div class="meta">
          ${time || ''}
        </div>
      `;
      messagesEl.appendChild(msgDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // Escape HTML to prevent injection
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Update the sidebar user list
    function updateUserList(users) {
      const userListEl = document.getElementById("userList");
      userListEl.innerHTML = "";

      users.forEach(user => {
        if (user.username === username) return; // skip self

        const userDiv = document.createElement("div");
        userDiv.classList.add("user-item");
        if (user.username === currentChatUser) {
          userDiv.classList.add("active");
        }

        // Avatar
        const avatarDiv = document.createElement("div");
        avatarDiv.classList.add("user-avatar");
        avatarDiv.textContent = user.username[0].toUpperCase();

        // Username text
        const nameSpan = document.createElement("span");
        nameSpan.classList.add("user-name");
        nameSpan.textContent = user.nickname || user.username;

        // Online status dot
        const onlineDot = document.createElement("div");
        onlineDot.classList.add("online-dot");
        onlineDot.style.backgroundColor = user.online ? "#25d366" : "#777";
        onlineDot.title = user.online ? "Online" : "Offline";

        userDiv.appendChild(avatarDiv);
        userDiv.appendChild(nameSpan);
        userDiv.appendChild(onlineDot);

        userDiv.onclick = () => selectChatUser(user.username);

        userListEl.appendChild(userDiv);
      });
    }

    // Select a user to chat with
    function selectChatUser(user) {
      currentChatUser = user;
      document.getElementById("chatWith").textContent = user;
      document.getElementById("chatAvatar").textContent = user[0].toUpperCase();
      document.getElementById("chatInputArea").style.display = "flex";
      clearMessages();
      // Request chat history from server
      socket.emit('get_history', { from: username, to: user });
    }

    // Clear chat messages area
    function clearMessages() {
      document.getElementById("messages").innerHTML = "";
    }

    // Receive chat history from server
    socket.on('chat_history', history => {
      clearMessages();
      selectedMessages.clear();
      updateDeleteBtn();
      history.forEach(msg => {
        addMessageToChat(msg.from, msg.message, msg.time, msg.read);
      });
    });

    // Send message handler
    function sendMessage() {
      const input = document.getElementById("messageInput");
      const text = input.value.trim();
      if (!text || !currentChatUser) return;

      socket.emit('private_message', {
        from: username,
        to: currentChatUser,
        message: text
      });
      input.value = "";
      input.focus();
    }

    // Send on Enter key
    document.getElementById("messageInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        sendMessage();
      }
    });

    // Send button click
    document.getElementById("sendButton").addEventListener("click", sendMessage);

  </script>
</body>
</html>
