<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat-by-Aaditya</title>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", "Roboto", Arial, sans-serif;
      height: 100vh;
      background-color: #111b21;
      color: #e9edef;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .container {
      display: flex;
      height: 100vh;
      width: 100vw;
      background: #111b21;
    }
    .sidebar {
      width: 340px;
      background-color: #202c33;
      border-right: 1px solid #222d34;
      display: flex;
      flex-direction: column;
      color: #e9edef;
      overflow-y: auto;
      box-shadow: 2px 0 16px 0 #0004;
    }
    .sidebar-header {
      display: flex;
      align-items: center;
      padding: 18px 22px;
      border-bottom: 1px solid #222d34;
      font-weight: 600;
      font-size: 1.2em;
      gap: 12px;
      background-color: #2a3942;
      flex-shrink: 0;
      border-top-left-radius: 16px;
    }
    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background-color: #6bcbef;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.35em;
      color: white;
      user-select: none;
      overflow: hidden;
    }
    #userList {
      flex: 1;
      overflow-y: auto;
    }
    .user-item {
      display: flex;
      align-items: center;
      padding: 14px 22px;
      cursor: pointer;
      gap: 12px;
      border-bottom: 1px solid #222d34;
      transition: background-color 0.2s;
      border-radius: 0 16px 16px 0;
    }
    .user-item:hover {
      background-color: #2f3d46;
    }
    .user-item.active {
      background-color: #222d34;
      font-weight: 600;
    }
    .user-avatar {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background-color: #008069;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1em;
      color: white;
      user-select: none;
      flex-shrink: 0;
      overflow: hidden;
    }
    .user-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }
    .user-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .online-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: #25d366;
      flex-shrink: 0;
      margin-left: auto;
    }
    .chat-window {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: #111b21;
      background-image: url('https://web.whatsapp.com/img/bg-chat-tile_7b705cb1c2ef3d06efba.png');
      background-repeat: repeat;
      background-position: center;
      overflow: hidden;
      border-top-right-radius: 16px;
      border-bottom-right-radius: 16px;
    }
    .chat-header {
      display: flex;
      align-items: center;
      padding: 18px 28px;
      background-color: #2a3942;
      border-bottom: 1px solid #222d34;
      gap: 12px;
      font-weight: 600;
      font-size: 1.2em;
      color: #e9edef;
      flex-shrink: 0;
      border-top-right-radius: 16px;
    }
    .chat-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background-color: #6bcbef;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.35em;
      color: white;
      user-select: none;
      flex-shrink: 0;
      overflow: hidden;
    }
    #messages {
      flex: 1;
      padding: 24px 48px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      font-size: 1em;
    }
    .message {
      max-width: 60%;
      padding: 14px 20px;
      border-radius: 12px;
      position: relative;
      word-wrap: break-word;
      font-size: 1em;
      line-height: 1.4;
      user-select: text;
      box-shadow: 0 2px 8px 0 #0002;
      margin-bottom: 2px;
    }
    .outgoing {
      background-color: #005c4b;
      color: #e9edef;
      margin-left: auto;
      border-bottom-right-radius: 2px;
      text-align: right;
    }
    .incoming {
      background-color: #202c33;
      color: #e9edef;
      margin-right: auto;
      border-bottom-left-radius: 2px;
      text-align: left;
    }
    .message .meta {
      font-size: 0.75em;
      color: #b6b9bb;
      margin-top: 6px;
      opacity: 0.8;
      user-select: none;
    }
    .chat-input-area {
      display: flex;
      padding: 18px 28px;
      background-color: #202c33;
      border-top: 1px solid #222d34;
      gap: 10px;
      flex-shrink: 0;
      border-bottom-right-radius: 16px;
    }
    #messageInput {
      flex: 1;
      padding: 14px 20px;
      border-radius: 24px;
      border: none;
      outline: none;
      font-size: 1em;
      background-color: #2a3942;
      color: #e9edef;
      transition: background 0.2s;
    }
    #messageInput::placeholder {
      color: #888f95;
    }
    #messageInput:focus {
      background-color: #222d34;
      outline: 2px solid #25d366;
    }
    #sendButton {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      background-color: #25d366;
      color: #111b21;
      font-size: 1.5em;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
    }
    #sendButton:hover {
      background-color: #128c7e;
      color: #fff;
    }
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      background: #111b21;
    }
    ::-webkit-scrollbar-thumb {
      background: #222d34;
      border-radius: 4px;
    }
    .message.selected {
      outline: 2px solid #ff6b6b;
      background-color: #2a3942 !important;
    }
    #deleteSelectedBtn {
      display: none;
      margin: 10px 48px 0 48px;
      padding: 10px 18px;
      background: #ff6b6b;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      font-weight: 500;
      letter-spacing: 1px;
    }
    #deleteSelectedBtn.active {
      display: block;
    }
    /* Profile Modal WhatsApp style */
    #profileModal {
      background: rgba(0,0,0,0.7);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #profileModal > div {
      background: #202c33;
      border-radius: 16px;
      box-shadow: 0 4px 32px 0 #0006;
    }
    .msg-ticks {
      display: inline-block;
      margin-left: 6px;
      vertical-align: middle;
      font-size: 1em;
      line-height: 1;
    }
    .msg-ticks svg {
      vertical-align: middle;
      margin-left: -2px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="avatar" id="myAvatar"></div>
        <span id="myUsername"></span>
        <button id="profileBtn" title="Profile" style="margin-left:10px;background:none;border:none;cursor:pointer;display:flex;align-items:center;">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="8" r="4" fill="#6bcbef"/>
            <rect x="4" y="16" width="16" height="4" rx="2" fill="#6bcbef"/>
          </svg>
        </button>
        <a href="/logout" id="logoutBtn" title="Logout" style="margin-left:auto;display:flex;align-items:center;">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" style="display:block;" xmlns="http://www.w3.org/2000/svg">
            <rect x="2" y="4" width="12" height="16" rx="2" fill="#202c33" stroke="#ff6b6b" stroke-width="2"/>
            <path d="M16 12h4m0 0l-2-2m2 2l-2 2" stroke="#ff6b6b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
      </div>
      <div id="userList"></div>
    </div>
    <div class="chat-window">
      <div class="chat-header">
        <div class="chat-avatar" id="chatAvatar">
          <svg id="chatAvatarLogo" width="44" height="44" viewBox="0 0 40 40" style="display:none;"></svg>
        </div>
        <div id="chatWith" style="flex:1;">
          <span id="chatWithText" style="font-weight:600;font-size:1.1em;">Select a user to chat</span>
        </div>
        <!-- Three dots menu -->
        <div style="position:relative;">
          <button id="chatMenuBtn" title="Menu" style="background:none;border:none;cursor:pointer;padding:8px;">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="5" r="2" fill="#b6b9bb"/>
              <circle cx="12" cy="12" r="2" fill="#b6b9bb"/>
              <circle cx="12" cy="19" r="2" fill="#b6b9bb"/>
            </svg>
          </button>
          <div id="chatMenuDropdown" style="display:none;position:absolute;right:0;top:36px;background:#202c33;border-radius:8px;box-shadow:0 2px 8px #0006;min-width:160px;z-index:10;">
            <button id="showRepProfileBtn" style="width:100%;background:none;border:none;color:#25d366;padding:12px 18px;text-align:left;font-size:1em;cursor:pointer;border-radius:8px 8px 0 0;">View Profile</button>
            <button id="deleteAllBtn" style="width:100%;background:none;border:none;color:#ff6b6b;padding:12px 18px;text-align:left;font-size:1em;cursor:pointer;">Delete all messages</button>
          </div>
        </div>
      </div>
      <button id="deleteSelectedBtn">Delete Selected</button>
      <div id="messages"></div>
      <div class="chat-input-area" id="chatInputArea" style="display:none;">
        <input id="messageInput" placeholder="Type a message..." autocomplete="off" />
        <input type="file" id="mediaInput" style="display:none;" />
        <button id="mediaButton" title="Attach media" style="background:none;border:none;cursor:pointer;font-size:1.5em;color:#25d366;">&#128247;</button>
        <button id="sendButton" title="Send message">&#10148;</button>
      </div>
    </div>
  </div>
  <!-- Profile Modal -->
  <div id="profileModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:1000;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;">
    <div style="background:#202c33;padding:36px 40px 28px 40px;border-radius:18px;min-width:340px;max-width:95vw;position:relative;box-shadow:0 4px 32px 0 #0006;">
      <button id="closeProfile" style="position:absolute;top:12px;right:12px;background:none;border:none;color:#ff6b6b;font-size:1.7em;cursor:pointer;">&times;</button>
      <div style="display:flex;flex-direction:column;align-items:center;">
        <div style="position:relative;margin-bottom:18px;">
          <img id="profileAvatarImg" src="" alt="Avatar" style="width:100px;height:100px;border-radius:50%;background:#6bcbef;object-fit:cover;border:4px solid #25d366;">
          <label for="avatarInput" style="position:absolute;bottom:0;right:0;background:#25d366;color:#fff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.3em;box-shadow:0 2px 8px #0003;">
            <input id="avatarInput" type="file" accept="image/*" style="display:none;">
            &#9998;
          </label>
        </div>
        <div style="width:100%;max-width:320px;">
          <div style="font-size:1.2em;font-weight:600;text-align:center;margin-bottom:8px;">
            <span id="profileUsername"></span>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;">
            <div id="profileFullName" style="color:#b6b9bb;font-size:1em;"></div>
            <div id="profileNickname" style="color:#b6b9bb;font-size:1em;"></div>
            <div id="profileEmail" style="color:#b6b9bb;font-size:1em;"></div>
            <div id="profileMobile" style="color:#b6b9bb;font-size:1em;"></div>
            <div id="profileLastSeen" style="color:#b6b9bb;font-size:1em;"></div>
            <div id="profileOnline" style="color:#b6b9bb;font-size:1em;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    const socket = io();
    const username = "{{ username }}";  // Flask template variable

    let currentChatUser = null;

    // Initialize UI
    document.getElementById("myUsername").textContent = username;
    document.getElementById("myAvatar").textContent = username[0].toUpperCase();

    // Join the chat room with username
    socket.emit('join', username);

    // Receive the list of users from server
    socket.on('users', users => {
      updateUserList(users);
    });

    // Listen for incoming private messages
    socket.on('private_message', data => {
      if (data.from === currentChatUser || data.from === username || data.to === currentChatUser) {
        // For outgoing messages, pass data.read; for incoming, always true (no ticks)
        addMessageToChat(data.from, data.message, data.time, data.from === username ? data.read : true);
      }
    });

    // --- Message selection and deletion logic ---
    let selectedMessages = new Set();

    function addMessageToChat(from, message, time, read) {
      const messagesEl = document.getElementById("messages");
      const msgDiv = document.createElement("div");
      const isOutgoing = from === username;
      msgDiv.classList.add("message");
      msgDiv.classList.add(isOutgoing ? "outgoing" : "incoming");
      msgDiv.dataset.time = time || "";
      msgDiv.dataset.from = from;

      // Ticks for outgoing messages
      let ticks = "";
      if (isOutgoing) {
        if (read) {
          // Seen: sky blue ticks
          ticks = `<span class="msg-ticks" style="float:right;margin-left:8px;">
            <svg width="18" height="14" viewBox="0 0 18 14" style="vertical-align:middle;"><polyline points="1 7 7 13 17 3" fill="none" stroke="#6bcbef" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><polyline points="5 7 11 13 17 7" fill="none" stroke="#6bcbef" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>`;
        } else {
          // Not seen: grey ticks
          ticks = `<span class="msg-ticks" style="float:right;margin-left:8px;">
            <svg width="18" height="14" viewBox="0 0 18 14" style="vertical-align:middle;"><polyline points="1 7 7 13 17 3" fill="none" stroke="#b6b9bb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><polyline points="5 7 11 13 17 7" fill="none" stroke="#b6b9bb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>`;
        }
      }

      msgDiv.innerHTML = `
        <div style="position:relative;">
          ${escapeHtml(message)}
        </div>
        <div class="meta" style="display:flex;align-items:center;justify-content:flex-end;gap:2px;">
          <span>${time || ''}</span>${ticks}
        </div>
      `;
      messagesEl.appendChild(msgDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function updateDeleteBtn() {
      const btn = document.getElementById("deleteSelectedBtn");
      if (selectedMessages.size > 0) {
        btn.classList.add("active");
      } else {
        btn.classList.remove("active");
      }
    }

    document.getElementById("deleteSelectedBtn").addEventListener("click", function () {
      if (!currentChatUser || selectedMessages.size === 0) return;
      if (!confirm("Delete selected messages?")) return;
      socket.emit('delete_messages', {
        from: username,
        to: currentChatUser,
        timestamps: Array.from(selectedMessages)
      });
      selectedMessages.clear();
      updateDeleteBtn();
    });

    // Helper to add a message to chat window
    function addMessageToChat(from, message, time, read) {
      const messagesEl = document.getElementById("messages");
      const msgDiv = document.createElement("div");
      const isOutgoing = from === username;
      msgDiv.classList.add("message");
      msgDiv.classList.add(isOutgoing ? "outgoing" : "incoming");
      msgDiv.innerHTML = `
        <div>${escapeHtml(message)}</div>
        <div class="meta">
          ${time || ''}
        </div>
      `;
      messagesEl.appendChild(msgDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // Escape HTML to prevent injection
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Add edit display name (nickname) for others
    function showEditDisplayName(targetUsername, currentDisplayName) {
      const newName = prompt("Enter a custom name for this user (leave blank to reset):", currentDisplayName || "");
      if (newName === null) return;
      fetch('/set_display_name', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ target: targetUsername, display_name: newName })
      })
      .then(res => res.json())
      .then(() => {
        // Refresh user list to reflect new display name
        socket.emit('join', username);
      });
    }

    // Update the sidebar user list
    function updateUserList(users) {
      window.lastUserList = users;
      const userListEl = document.getElementById("userList");
      userListEl.innerHTML = "";

      users.forEach(user => {
        if (user.username === username) return; // skip self

        const userDiv = document.createElement("div");
        userDiv.classList.add("user-item");
        if (user.username === currentChatUser) {
          userDiv.classList.add("active");
        }

        // Avatar
        const avatarDiv = document.createElement("div");
        avatarDiv.classList.add("user-avatar");
        if (user.avatar_url) {
          avatarDiv.innerHTML = `<img src="${user.avatar_url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
        } else {
          avatarDiv.textContent = user.username[0].toUpperCase();
        }

        // Username text
        const nameSpan = document.createElement("span");
        nameSpan.classList.add("user-name");
        nameSpan.textContent = user.nickname || user.username;

        // Edit icon for display name
        const editBtn = document.createElement("button");
        editBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 20 20" fill="none"><path d="M3 17h2.586l9.293-9.293a1 1 0 0 0 0-1.414l-2.172-2.172a1 1 0 0 0-1.414 0L3 13.586V17zm13.707-9.707a3 3 0 0 0 0-4.242l-2.172-2.172a3 3 0 0 0-4.242 0l-1.293 1.293 6.414 6.414 1.293-1.293z" fill="#25d366"/></svg>`;
        editBtn.title = "Set custom name";
        editBtn.style.background = "none";
        editBtn.style.border = "none";
        editBtn.style.cursor = "pointer";
        editBtn.style.marginLeft = "6px";
        editBtn.onclick = (e) => {
          e.stopPropagation();
          showEditDisplayName(user.username, user.nickname);
        };

        // Online status dot
        const onlineDot = document.createElement("div");
        onlineDot.classList.add("online-dot");
        onlineDot.style.backgroundColor = user.online ? "#25d366" : "#777";
        onlineDot.title = user.online ? "Online" : "Offline";

        userDiv.appendChild(avatarDiv);
        userDiv.appendChild(nameSpan);
        userDiv.appendChild(editBtn);
        userDiv.appendChild(onlineDot);

        userDiv.onclick = () => selectChatUser(user.username);

        userListEl.appendChild(userDiv);
      });
    }

    // Select a user to chat with
    function selectChatUser(user) {
      currentChatUser = user;
      document.getElementById("chatWithText").textContent = user;
      // Find user in user list to get avatar_url
      const userObj = Array.from(window.lastUserList || []).find(u => u.username === user);
      const chatAvatar = document.getElementById("chatAvatar");
      const chatAvatarLogo = document.getElementById("chatAvatarLogo");
      if (userObj && userObj.avatar_url) {
        chatAvatarLogo.style.display = "block";
        chatAvatarLogo.innerHTML = `<image href="${userObj.avatar_url}" width="40" height="40" style="border-radius:50%;"/>`;
      } else {
        chatAvatarLogo.style.display = "block";
        chatAvatarLogo.innerHTML = `<circle cx="20" cy="20" r="20" fill="#6bcbef"/><text x="50%" y="55%" text-anchor="middle" fill="#fff" font-size="20" font-family="Arial" dy=".3em">${user[0].toUpperCase()}</text>`;
      }
      document.getElementById("chatInputArea").style.display = "flex";
      clearMessages();
      // Request chat history from server
      socket.emit('get_history', { from: username, to: user });
    }

    // Save last user list for avatar lookup
    function updateUserList(users) {
      window.lastUserList = users;
      const userListEl = document.getElementById("userList");
      userListEl.innerHTML = "";

      users.forEach(user => {
        if (user.username === username) return; // skip self

        const userDiv = document.createElement("div");
        userDiv.classList.add("user-item");
        if (user.username === currentChatUser) {
          userDiv.classList.add("active");
        }

        // Avatar
        const avatarDiv = document.createElement("div");
        avatarDiv.classList.add("user-avatar");
        if (user.avatar_url) {
          avatarDiv.innerHTML = `<img src="${user.avatar_url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
        } else {
          avatarDiv.textContent = user.username[0].toUpperCase();
        }

        // Username text
        const nameSpan = document.createElement("span");
        nameSpan.classList.add("user-name");
        nameSpan.textContent = user.nickname || user.username;

        // Edit icon for display name
        const editBtn = document.createElement("button");
        editBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 20 20" fill="none"><path d="M3 17h2.586l9.293-9.293a1 1 0 0 0 0-1.414l-2.172-2.172a1 1 0 0 0-1.414 0L3 13.586V17zm13.707-9.707a3 3 0 0 0 0-4.242l-2.172-2.172a3 3 0 0 0-4.242 0l-1.293 1.293 6.414 6.414 1.293-1.293z" fill="#25d366"/></svg>`;
        editBtn.title = "Set custom name";
        editBtn.style.background = "none";
        editBtn.style.border = "none";
        editBtn.style.cursor = "pointer";
        editBtn.style.marginLeft = "6px";
        editBtn.onclick = (e) => {
          e.stopPropagation();
          showEditDisplayName(user.username, user.nickname);
        };

        // Online status dot
        const onlineDot = document.createElement("div");
        onlineDot.classList.add("online-dot");
        onlineDot.style.backgroundColor = user.online ? "#25d366" : "#777";
        onlineDot.title = user.online ? "Online" : "Offline";

        userDiv.appendChild(avatarDiv);
        userDiv.appendChild(nameSpan);
        userDiv.appendChild(editBtn);
        userDiv.appendChild(onlineDot);

        userDiv.onclick = () => selectChatUser(user.username);

        userListEl.appendChild(userDiv);
      });
    }

    // Clear chat messages area
    function clearMessages() {
      document.getElementById("messages").innerHTML = "";
    }

    // Receive chat history from server
    socket.on('chat_history', history => {
      clearMessages();
      selectedMessages.clear();
      updateDeleteBtn();
      history.forEach(msg => {
        // For outgoing messages, pass msg.read; for incoming, always true (no ticks)
        addMessageToChat(msg.from, msg.message, msg.time, msg.from === username ? msg.read : true);
      });
    });

    // Send message handler
    function sendMessage() {
      const input = document.getElementById("messageInput");
      const text = input.value.trim();
      if (!text || !currentChatUser) return;

      socket.emit('private_message', {
        from: username,
        to: currentChatUser,
        message: text
      });
      input.value = "";
      input.focus();
    }

    // Send on Enter key
    document.getElementById("messageInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        sendMessage();
      }
    });

    // Send button click
    document.getElementById("sendButton").addEventListener("click", sendMessage);

    // Profile modal logic
    const myAvatar = document.getElementById("myAvatar");
    const profileBtn = document.getElementById("profileBtn");
    const profileModal = document.getElementById("profileModal");
    const closeProfile = document.getElementById("closeProfile");
    const profileAvatarImg = document.getElementById("profileAvatarImg");
    const avatarInput = document.getElementById("avatarInput");
    const profileUsername = document.getElementById("profileUsername");
    const profileEmail = document.getElementById("profileEmail");
    const profileFullName = document.getElementById("profileFullName");
    const profileMobile = document.getElementById("profileMobile");
    const profileLastSeen = document.getElementById("profileLastSeen");
    const profileOnline = document.getElementById("profileOnline");

    // Fetch profile info from backend
    function loadProfile() {
      fetch('/profile')
        .then(res => res.json())
        .then(user => {
          profileUsername.textContent = user.username;
          profileEmail.textContent = user.email ? "Email: " + user.email : "";
          profileFullName.textContent = user.name ? "Full Name: " + user.name : "";
          profileMobile.textContent = user.mobile ? "Mobile: " + user.mobile : "";
          profileNickname.textContent = user.nickname ? "Nickname: " + user.nickname : "";
          profileLastSeen.textContent = user.last_seen ? "Last seen: " + user.last_seen : "";
          profileOnline.textContent = typeof user.online === "boolean" ? ("Online: " + (user.online ? "Yes" : "No")) : "";
          if (user.avatar_url) {
            profileAvatarImg.src = user.avatar_url;
            myAvatar.innerHTML = `<img src="${user.avatar_url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
          } else {
            profileAvatarImg.src = "";
            myAvatar.textContent = user.username[0].toUpperCase();
          }
        });
    }

    profileBtn.addEventListener("click", () => {
      loadProfile();
      profileModal.style.display = "flex";
    });
    closeProfile.addEventListener("click", () => {
      profileModal.style.display = "none";
    });

    // Avatar upload
    avatarInput.addEventListener("change", function() {
      const file = avatarInput.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append("avatar", file);
      fetch("/upload_avatar", { method: "POST", body: formData })
        .then(res => res.json())
        .then(data => {
          if (data.avatar_url) {
            profileAvatarImg.src = data.avatar_url;
            myAvatar.innerHTML = `<img src="${data.avatar_url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
          }
        });
    });

    // Three dots menu logic
    const chatMenuBtn = document.getElementById("chatMenuBtn");
    const chatMenuDropdown = document.getElementById("chatMenuDropdown");
    const deleteAllBtn = document.getElementById("deleteAllBtn");
    const showRepProfileBtn = document.getElementById("showRepProfileBtn");

    chatMenuBtn.addEventListener("click", function(e) {
      e.stopPropagation();
      chatMenuDropdown.style.display = chatMenuDropdown.style.display === "block" ? "none" : "block";
    });

    // Hide menu when clicking outside
    document.addEventListener("click", function(e) {
      chatMenuDropdown.style.display = "none";
    });

    // Prevent menu from closing when clicking inside
    chatMenuDropdown.addEventListener("click", function(e) {
      e.stopPropagation();
    });

    // Delete all messages function
    deleteAllBtn.addEventListener("click", function() {
      if (!currentChatUser) return;
      if (!confirm("Delete all messages in this chat?")) return;
      socket.emit('delete_messages', {
        from: username,
        to: currentChatUser,
        timestamps: getAllMessageTimestamps()
      });
      chatMenuDropdown.style.display = "none";
    });

    // Show representative profile function
    showRepProfileBtn.addEventListener("click", function() {
      if (!currentChatUser) return;
      showOtherProfile(currentChatUser);
      chatMenuDropdown.style.display = "none";
    });

    // Helper to get all timestamps of messages in this chat (both incoming and outgoing)
    function getAllMessageTimestamps() {
      const messages = document.querySelectorAll("#messages .message");
      return Array.from(messages).map(msg => msg.dataset.time).filter(Boolean);
    }

    // Show other user's profile modal
    function showOtherProfile(username) {
      fetch(`/user_profile/${encodeURIComponent(username)}`)
        .then(res => res.json())
        .then(user => {
          if (user.error) return;
          profileUsername.textContent = user.username;
          profileEmail.textContent = user.email ? "Email: " + user.email : "";
          profileFullName.textContent = user.name ? "Full Name: " + user.name : "";
          profileMobile.textContent = user.mobile ? "Mobile: " + user.mobile : "";
          profileNickname.textContent = user.nickname ? "Nickname: " + user.nickname : "";
          profileLastSeen.textContent = user.last_seen ? "Last seen: " + user.last_seen : "";
          profileOnline.textContent = typeof user.online === "boolean" ? ("Online: " + (user.online ? "Yes" : "No")) : "";
          if (user.avatar_url) {
            profileAvatarImg.src = user.avatar_url;
            profileAvatarImg.style.display = "";
            profileAvatarImg.style.objectFit = "cover";
            profileAvatarImg.style.objectPosition = "center";
            profileAvatarImg.style.width = "180px";
            profileAvatarImg.style.height = "180px";
            profileAvatarImg.style.borderRadius = "50%";
            profileAvatarImg.style.background = "#6bcbef";
            profileAvatarImg.style.border = "6px solid #25d366";
            profileAvatarImg.style.boxShadow = "0 4px 32px #0006";
          } else {
            profileAvatarImg.src = "";
            profileAvatarImg.style.display = "none";
          }
          // Hide avatar upload for others
          avatarInput.parentElement.style.display = "none";
          profileModal.style.display = "flex";
        });
    }

    // When closing profile modal, re-enable own profile editing and show avatar upload
    closeProfile.addEventListener("click", () => {
      profileModal.style.display = "none";
      avatarInput.parentElement.style.display = "";
    });

    // Media sharing logic
    const mediaInput = document.getElementById("mediaInput");
    const mediaButton = document.getElementById("mediaButton");

    mediaButton.addEventListener("click", () => {
      mediaInput.click();
    });

    mediaInput.addEventListener("change", function() {
      const file = mediaInput.files[0];
      if (!file || !currentChatUser) return;
      const formData = new FormData();
      formData.append("media", file);
      fetch("/upload_media", { method: "POST", body: formData })
        .then(res => res.json())
        .then(data => {
          if (data.media_url) {
            let media_type = "file";
            if (file.type.startsWith("image/")) media_type = "image";
            else if (file.type.startsWith("video/")) media_type = "video";
            else if (file.type.startsWith("audio/")) media_type = "audio";
            const caption = prompt("Add a caption (optional):", "");
            socket.emit('media_message', {
              from: username,
              to: currentChatUser,
              media_url: data.media_url,
              media_type,
              caption: caption || ""
            });
          }
        });
      mediaInput.value = "";
    });

    // Listen for incoming media messages
    socket.on('media_message', data => {
      if (data.from === currentChatUser || data.from === username || data.to === currentChatUser) {
        addMediaMessageToChat(data.from, data.media_url, data.media_type, data.caption, data.time, data.read);
      }
    });

    function addMediaMessageToChat(from, media_url, media_type, caption, time, read) {
      const messagesEl = document.getElementById("messages");
      const msgDiv = document.createElement("div");
      const isOutgoing = from === username;
      msgDiv.classList.add("message");
      msgDiv.classList.add(isOutgoing ? "outgoing" : "incoming");
      let mediaHtml = "";
      if (media_type === "image") {
        mediaHtml = `<img src="${media_url}" alt="image" style="max-width:220px;max-height:180px;border-radius:8px;display:block;margin-bottom:6px;border:1px solid #333;">`;
      } else if (media_type === "video") {
        mediaHtml = `<video src="${media_url}" controls style="max-width:220px;max-height:180px;border-radius:8px;display:block;margin-bottom:6px;border:1px solid #333;"></video>`;
      } else if (media_type === "audio") {
        mediaHtml = `<audio src="${media_url}" controls style="width:200px;display:block;margin-bottom:6px;"></audio>`;
      } else {
        // generic file
        mediaHtml = `<a href="${media_url}" target="_blank" style="color:#25d366;word-break:break-all;">Download file</a>`;
      }
      // Ticks for outgoing messages
      let ticks = "";
      if (isOutgoing) {
        if (read) {
          ticks = `<span class="msg-ticks" style="float:right;margin-left:8px;">
            <svg width="18" height="14" viewBox="0 0 18 14" style="vertical-align:middle;"><polyline points="1 7 7 13 17 3" fill="none" stroke="#6bcbef" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><polyline points="5 7 11 13 17 7" fill="none" stroke="#6bcbef" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>`;
        } else {
          ticks = `<span class="msg-ticks" style="float:right;margin-left:8px;">
            <svg width="18" height="14" viewBox="0 0 18 14" style="vertical-align:middle;"><polyline points="1 7 7 13 17 3" fill="none" stroke="#b6b9bb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><polyline points="5 7 11 13 17 7" fill="none" stroke="#b6b9bb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>`;
        }
      }
      msgDiv.innerHTML = `
        <div style="position:relative;">
          ${mediaHtml}
          ${caption ? `<div style="margin-bottom:4px;">${escapeHtml(caption)}</div>` : ""}
        </div>
        <div class="meta" style="display:flex;align-items:center;justify-content:flex-end;gap:2px;">
          <span>${time || ''}</span>${ticks}
        </div>
      `;
      messagesEl.appendChild(msgDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
  </script>
</body>
</html>
