<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat-by-Aaditya</title>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", "Roboto", Arial, sans-serif;
      height: 100vh;
      background: linear-gradient(135deg, #232526 0%, #25d366 100%);
      color: #e9edef;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .container {
      display: flex;
      height: 96vh;
      width: 96vw;
      background: rgba(17,27,33,0.97);
      box-shadow: 0 8px 32px 0 #000a;
      border-radius: 32px;
      margin: 2vh auto;
      overflow: hidden;
      border: 2.5px solid #25d366;
      animation: popin 0.7s cubic-bezier(.68,-0.55,.27,1.55);
      position: relative;
      transition: transform 0.4s cubic-bezier(.68,-0.55,.27,1.55);
      backdrop-filter: blur(2px);
    }
    .sidebar {
      width: 260px;
      min-width: 160px;
      background: linear-gradient(180deg, #075e54 0%, #202c33 100%);
      border-right: 2.5px solid #128c7e;
      display: flex;
      flex-direction: column;
      color: #e9edef;
      overflow-y: auto;
      border-radius: 0;
      box-shadow: 2px 0 16px 0 #0006;
      position: relative;
      z-index: 2;
      transition: box-shadow 0.2s;
    }
    .sidebar-header {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 8px;
      padding: 18px 14px 10px 14px;
      border-bottom: 1px solid #128c7e;
      font-weight: 600;
      font-size: 1.1em;
      background: linear-gradient(90deg, #128c7e 0%, #075e54 100%);
      border-radius: 0;
      box-shadow: 0 2px 8px #0003;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    #statusSlideBtn {
      width: 100%;
      background: #232d33;
      color: #25d366;
      border: 1.5px solid #25d366;
      border-radius: 8px;
      padding: 8px 0;
      font-weight: 600;
      font-size: 1em;
      cursor: pointer;
      margin-bottom: 8px;
      margin-top: 6px;
      transition: background 0.15s, color 0.15s, border 0.15s;
      box-shadow: 0 2px 8px #25d36622;
    }
    #statusSlideBtn:hover, #statusSlideBtn.active {
      background: #25d366;
      color: #111b21;
      border-color: #128c7e;
    }
    #chatSearchInput {
      width: 95%;
      margin: 8px auto 8px auto;
      padding: 6px 12px;
      border-radius: 8px;
      border: 1.5px solid #25d366;
      background: #232d33;
      color: #e9edef;
      font-size: 1em;
      outline: none;
      display: block;
      box-shadow: 0 2px 8px #25d36622;
      transition: border 0.15s, background 0.15s;
    }
    #chatSearchInput:focus {
      border: 1.5px solid #128c7e;
      background: #1e2c2f;
    }
    #chatSearchInput::placeholder {
      color: #b6b9bb;
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6bcbef 0%, #25d366 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.3em;
      color: white;
      user-select: none;
      overflow: hidden;
      border: 2px solid #25d366;
      box-shadow: 0 2px 8px #25d36633;
      transition: box-shadow 0.2s;
      animation: pulse 2.5s infinite;
      margin: 0 auto 4px auto;
    }
    .avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      display: block;
    }
    #userList {
      flex: 1;
      overflow-y: auto;
      border-top: 1px solid #128c7e;
      border-bottom: 1px solid #128c7e;
      background: #1e2c2f;
      border-radius: 0;
      margin-bottom: 0;
      box-shadow: none;
      padding-top: 8px;
    }
    .user-item {
      display: flex;
      align-items: center;
      padding: 10px 14px;
      cursor: pointer;
      gap: 10px;
      border-bottom: 1px solid #128c7e;
      border-radius: 8px;
      transition: background 0.15s, border 0.15s;
      background: transparent;
      font-size: 1em;
      border: 2px solid #25d366;
      margin-bottom: 10px;
    }
    .user-item:hover, .user-item.active {
      background: #233138;
      border-left: 3px solid #25d366;
      border-color: #128c7e;
    }
    .user-item:last-child {
      border-bottom: none;
    }
    .user-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #25d366;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1em;
      color: white;
      user-select: none;
      flex-shrink: 0;
      overflow: hidden;
      border: 1.5px solid #25d366;
      box-shadow: none;
    }
    .user-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }
    .user-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 600;
      color: #e9edef;
      font-size: 1em;
      letter-spacing: 0.5px;
    }
    .online-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: #25d366;
      flex-shrink: 0;
      margin-left: auto;
      border: 1px solid #202c33;
      box-shadow: none;
    }
    .chat-window {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #232526;
      background-image: none;
      overflow: hidden;
      border-radius: 0;
      box-shadow: none;
    }
    .chat-header {
      display: flex;
      align-items: center;
      padding: 14px 20px;
      background: #128c7e;
      border-bottom: 1px solid #128c7e;
      gap: 12px;
      font-weight: 700;
      font-size: 1.1em;
      color: #e9edef;
      flex-shrink: 0;
      border-radius: 0;
      min-height: 44px;
      box-shadow: none;
    }
    .chat-avatar {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: #25d366;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2em;
      color: white;
      user-select: none;
      flex-shrink: 0;
      overflow: hidden;
      border: 1.5px solid #25d366;
      box-shadow: none;
    }
    #messages {
      flex: 1;
      padding: 18px 24px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 1em;
      background: transparent;
    }
    .message {
      max-width: 80%;
      padding: 10px 16px;
      border-radius: 12px;
      position: relative;
      word-wrap: break-word;
      font-size: 1em;
      line-height: 1.5;
      user-select: text;
      box-shadow: none;
      margin-bottom: 2px;
      border: none;
      transition: box-shadow 0.15s, background 0.15s;
    }
    .outgoing {
      background: #075e54;
      color: #e9edef;
      margin-left: auto;
      border-bottom-right-radius: 2px;
      text-align: right;
      border: 1px solid #25d366;
      box-shadow: none;
    }
    .incoming {
      background: #202c33;
      color: #e9edef;
      margin-right: auto;
      border-bottom-left-radius: 2px;
      text-align: left;
      border: 1px solid #202c33;
      box-shadow: none;
    }
    .message .meta {
      font-size: 0.85em;
      color: #b6b9bb;
      margin-top: 6px;
      opacity: 0.8;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 2px;
    }
    .chat-input-area {
      display: flex;
      padding: 14px 20px;
      background: #128c7e;
      border-top: 1px solid #128c7e;
      gap: 10px;
      flex-shrink: 0;
      border-radius: 0;
      align-items: center;
      box-shadow: none;
    }
    #messageInput {
      flex: 1;
      padding: 10px 14px;
      border-radius: 14px;
      border: none;
      outline: none;
      font-size: 1em;
      background: #2a3942;
      color: #e9edef;
      transition: background 0.15s;
      border: 1px solid #222d34;
      box-shadow: none;
    }
    #messageInput::placeholder {
      color: #888f95;
    }
    #messageInput:focus {
      background: #222d34;
      outline: 1.5px solid #25d366;
      border: 1.5px solid #25d366;
    }
    #mediaButton {
      margin-right: 2px;
      background: none;
      border: none;
      color: #25d366;
      font-size: 1.3em;
      cursor: pointer;
      border-radius: 50%;
      transition: background 0.15s;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: none;
    }
    #mediaButton:hover {
      background: #222d34;
      color: #128c7e;
    }
    #sendButton {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      border: none;
      background: #25d366;
      color: #111b21;
      font-size: 1.3em;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.15s;
      box-shadow: none;
    }
    #sendButton:hover {
      background: #128c7e;
      color: #fff;
    }
    .message img, .message video {
      max-width: 160px;
      max-height: 120px;
      border-radius: 8px;
      display: block;
      margin-bottom: 6px;
      border: 1px solid #25d366;
      background: #111b21;
      box-shadow: none;
    }
    .message audio {
      width: 120px;
      display: block;
      margin-bottom: 6px;
      background: #2a3942;
      border-radius: 4px;
      border: 1px solid #128c7e;
    }
    ::-webkit-scrollbar {
      width: 6px;
      background: #111b21;
    }
    ::-webkit-scrollbar-thumb {
      background: #222d34;
      border-radius: 3px;
    }
    .message.selected {
      outline: 1.5px solid #ff6b6b;
      background: #2a3942 !important;
    }
    #deleteSelectedBtn {
      display: none;
      margin: 8px 24px 0 24px;
      padding: 8px 12px;
      background: #ff6b6b;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 1px;
      box-shadow: none;
    }
    #deleteSelectedBtn.active {
      display: block;
    }
    #profileModal {
      background: rgba(0,0,0,0.7);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #profileModal > div {
      background: #202c33;
      border-radius: 12px;
      box-shadow: none;
      padding: 24px 24px 16px 24px;
      min-width: 200px;
      max-width: 95vw;
    }
    .msg-ticks {
      display: inline-block;
      margin-left: 4px;
      vertical-align: middle;
      font-size: 1em;
      line-height: 1;
    }
    .msg-ticks svg {
      vertical-align: middle;
      margin-left: -2px;
    }
    @media (max-width: 900px) {
      .container { flex-direction: column; width: 100vw; height: 100vh; border-radius: 0; margin: 0; }
      .sidebar, .chat-window { border-radius: 0; }
      #messages { padding: 8px 2vw; }
      .chat-header, .chat-input-area { padding: 8px 2vw; }
      .sidebar { width: 100vw; min-width: 0; }
    }
    @media (max-width: 600px) {
      .sidebar-header { padding: 10px 4vw 6px 4vw; }
      .chat-header, .chat-input-area { padding: 8px 2vw; }
      .container { border-radius: 0; }
      .chat-window { border-radius: 0; }
    }
  </style>
</head>
<body>
  <div class="container" id="mainContainer">
    <div class="sidebar">
      <div class="sidebar-header">
        <button id="statusSlideBtn" title="View Status">Status</button>
        <input id="chatSearchInput" type="text" placeholder="Search chats...">
        <div class="avatar" id="myAvatar"></div>
        <span id="myUsername"></span>
        <button id="profileBtn" title="Profile" style="margin-left:10px;background:none;border:none;cursor:pointer;display:flex;align-items:center;">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="8" r="4" fill="#6bcbef"/>
            <rect x="4" y="16" width="16" height="4" rx="2" fill="#6bcbef"/>
          </svg>
        </button>
      </div>
      <div id="userList"></div>
    </div>
    <div class="chat-window">
      <div class="chat-header">
        <div class="chat-avatar" id="chatAvatar">
          <svg id="chatAvatarLogo" width="44" height="44" viewBox="0 0 40 40" style="display:none;"></svg>
        </div>
        <div id="chatWith" style="flex:1;">
          <span id="chatWithText" style="font-weight:700;font-size:1.1em;">Select a user to chat</span>
        </div>
        <div style="position:relative;">
          <button id="chatMenuBtn" title="Menu" style="background:none;border:none;cursor:pointer;padding:8px;">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="5" r="2" fill="#b6b9bb"/>
              <circle cx="12" cy="12" r="2" fill="#b6b9bb"/>
              <circle cx="12" cy="19" r="2" fill="#b6b9bb"/>
            </svg>
          </button>
          <div id="chatMenuDropdown" style="display:none;position:absolute;right:0;top:36px;background:#202c33;border-radius:8px;box-shadow:0 2px 8px #0006;min-width:160px;z-index:10;">
            <button id="showRepProfileBtn" style="width:100%;background:none;border:none;color:#25d366;padding:12px 18px;text-align:left;font-size:1em;cursor:pointer;border-radius:8px 8px 0 0;">View Profile</button>
            <button id="deleteAllBtn" style="width:100%;background:none;border:none;color:#ff6b6b;padding:12px 18px;text-align:left;font-size:1em;cursor:pointer;">Delete all messages</button>
            <a href="/logout" id="logoutBtn" style="width:100%;display:block;background:none;border:none;color:#ff6b6b;padding:12px 18px;text-align:left;font-size:1em;cursor:pointer;text-decoration:none;border-radius:0 0 8px 8px;">Logout</a>
          </div>
        </div>
      </div>
      <button id="deleteSelectedBtn">Delete Selected</button>
      <div id="messages"></div>
      <div class="chat-input-area" id="chatInputArea" style="display:none;">
        <input id="messageInput" placeholder="Type a message..." autocomplete="off" />
        <input type="file" id="mediaInput" style="display:none;" />
        <button id="mediaButton" title="Attach media" style="background:none;border:none;cursor:pointer;font-size:1.5em;color:#25d366;">&#128247;</button>
        <button id="sendButton" title="Send message">&#10148;</button>
      </div>
    </div>
    <!-- Status Slide Panel (right side) -->
    <div id="statusSlidePanel" class="status-slide-panel">
      <div class="status-slide-header">
        <span>Status</span>
        <button class="status-slide-close" id="closeStatusSlidePanelBtn">&times;</button>
      </div>
      <div class="status-slide-section-title">My Status</div>
      <div id="statusSlideMyList" class="status-slide-list"></div>
      <div class="status-slide-section-title">Recent updates</div>
      <div id="statusSlideList" class="status-slide-list"></div>
      <div id="statusSlideViewer" class="status-slide-viewer">
        <div id="statusSlideViewerNickname" class="status-slide-viewer-nickname"></div>
        <img id="statusSlideViewerMedia" class="status-slide-viewer-media" src="" alt="Status Media">
        <video id="statusSlideViewerVideo" class="status-slide-viewer-video" controls></video>
        <div id="statusSlideViewerText" class="status-slide-viewer-text"></div>
        <div id="statusSlideViewerTime" class="status-slide-viewer-time"></div>
        <div class="status-slide-viewer-nav">
          <button id="statusSlidePrevBtn">&#8592;</button>
          <button id="statusSlideNextBtn">&#8594;</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Profile Modal -->
  <div id="profileModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:1000;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;">
    <div style="background:#202c33;padding:36px 40px 28px 40px;border-radius:18px;min-width:340px;max-width:95vw;position:relative;box-shadow:0 4px 32px 0 #0006;">
      <button id="closeProfile" style="position:absolute;top:12px;right:12px;background:none;border:none;color:#ff6b6b;font-size:1.7em;cursor:pointer;">&times;</button>
      <div style="display:flex;flex-direction:column;align-items:center;">
        <div style="position:relative;margin-bottom:18px;">
          <img id="profileAvatarImg" src="" alt="Avatar" style="width:100px;height:100px;border-radius:50%;background:#6bcbef;object-fit:cover;border:4px solid #25d366;">
          <label for="avatarInput" style="position:absolute;bottom:0;right:0;background:#25d366;color:#fff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.3em;box-shadow:0 2px 8px #0003;">
            <input id="avatarInput" type="file" accept="image/*" style="display:none;">
            &#9998;
          </label>
        </div>
        <div style="width:100%;max-width:320px;">
          <div style="font-size:1.2em;font-weight:600;text-align:center;margin-bottom:8px;">
            <span id="profileUsername"></span>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;">
            <div id="profileFullName" style="color:#b6b9bb;font-size:1em;"></div>
            <div id="profileNickname" style="color:#b6b9bb;font-size:1em;"></div>
            <div id="profileEmail" style="color:#b6b9bb;font-size:1em;"></div>
            <div id="profileMobile" style="color:#b6b9bb;font-size:1em;"></div>
            <div id="profileLastSeen" style="color:#b6b9bb;font-size:1em;"></div>
            <div id="profileOnline" style="color:#b6b9bb;font-size:1em;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Status Slide Modal -->
  <div id="statusSlide">
    <button id="closeStatusSlide">&times;</button>
    <div id="statusSlideContent">
      <img id="statusAvatar" src="" alt="Status Avatar">
      <img id="statusMedia" src="" alt="Status Media">
      <div id="statusText"></div>
      <div id="statusTime"></div>
      <form id="statusUploadForm" style="display:none;">
        <input type="file" id="statusMediaInput" accept="image/*,video/*">
        <input type="text" id="statusTextInput" maxlength="120" placeholder="Type a status...">
        <button type="submit">Upload Status</button>
      </form>
    </div>
  </div>
  <!-- WhatsApp-like Status Viewer Slide -->
  <div id="statusViewerSlide" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:2100;background:rgba(17,27,33,0.98);align-items:center;justify-content:center;flex-direction:column;">
    <button id="closeStatusViewerSlide" style="position:absolute;top:24px;right:36px;background:none;border:none;color:#ff6b6b;font-size:2em;cursor:pointer;z-index:2200;">&times;</button>
    <div id="statusViewerContent" style="background:#222d34;border-radius:24px;padding:32px 40px;box-shadow:0 4px 32px #0008;display:flex;flex-direction:column;align-items:center;min-width:320px;max-width:90vw;position:relative;">
      <!-- Add clickable overlays for left/right -->
      <div class="status-viewer-side left" id="statusViewerPrevArea"></div>
      <div class="status-viewer-side right" id="statusViewerNextArea"></div>
      <img id="statusViewerAvatar" src="" alt="Status Avatar" style="width:90px;height:90px;border-radius:50%;background:#6bcbef;object-fit:cover;border:3px solid #25d366;margin-bottom:12px;box-shadow:0 2px 8px #0006;">
      <div id="statusViewerNickname" style="color:#e9edef;font-size:1.1em;font-weight:600;margin-bottom:8px;"></div>
      <img id="statusViewerMedia" src="" alt="Status Media" style="max-width:320px;max-height:320px;border-radius:18px;margin-bottom:18px;display:none;background:#111b21;border:2px solid #25d366;box-shadow:0 2px 8px #25d36633;">
      <video id="statusViewerVideo" controls style="max-width:320px;max-height:320px;border-radius:18px;margin-bottom:18px;display:none;background:#111b21;border:2px solid #25d366;box-shadow:0 2px 8px #25d36633;"></video>
      <div id="statusViewerText" style="color:#e9edef;font-size:1.1em;text-align:center;margin-bottom:12px;"></div>
      <div id="statusViewerTime" style="color:#b6b9bb;font-size:0.95em;text-align:center;margin-bottom:4px;"></div>
      <!-- Remove arrow navigation buttons -->
      <!-- <div style="display:flex;gap:18px;margin-top:10px;">
        <button id="prevStatusBtn" ...></button>
        <button id="nextStatusBtn" ...></button>
      </div> -->
    </div>
  </div>
  <script>
    const socket = io();
    const username = "{{ username }}";  // Flask template variable

    let currentChatUser = null;

    // Initialize UI
    document.getElementById("myUsername").textContent = username;
    document.getElementById("myAvatar").textContent = username[0].toUpperCase();

    // Join the chat room with username
    socket.emit('join', username);

    // Receive the list of users from server
    socket.on('users', users => {
      updateUserList(users);
    });

    // Listen for incoming private messages
    socket.on('private_message', data => {
      if (data.from === currentChatUser || data.from === username || data.to === currentChatUser) {
        // For outgoing messages, pass data.read; for incoming, always true (no ticks)
        addMessageToChat(data.from, data.message, data.time, data.from === username ? data.read : true);
      }
    });

    // --- Message selection and deletion logic ---
    let selectedMessages = new Set();

    function addMessageToChat(from, message, time, read) {
      const messagesEl = document.getElementById("messages");
      const msgDiv = document.createElement("div");
      const isOutgoing = from === username;
      msgDiv.classList.add("message");
      msgDiv.classList.add(isOutgoing ? "outgoing" : "incoming");
      msgDiv.dataset.time = time || "";
      msgDiv.dataset.from = from;

      // Ticks for outgoing messages
      let ticks = "";
      if (isOutgoing) {
        if (read) {
          // Seen: sky blue ticks
          ticks = `<span class="msg-ticks" style="float:right;margin-left:8px;">
            <svg width="18" height="14" viewBox="0 0 18 14" style="vertical-align:middle;"><polyline points="1 7 7 13 17 3" fill="none" stroke="#6bcbef" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><polyline points="5 7 11 13 17 7" fill="none" stroke="#6bcbef" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>`;
        } else {
          // Not seen: grey ticks
          ticks = `<span class="msg-ticks" style="float:right;margin-left:8px;">
            <svg width="18" height="14" viewBox="0 0 18 14" style="vertical-align:middle;"><polyline points="1 7 7 13 17 3" fill="none" stroke="#b6b9bb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><polyline points="5 7 11 13 17 7" fill="none" stroke="#b6b9bb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>`;
        }
      }

      msgDiv.innerHTML = `
        <div style="position:relative;">
          ${escapeHtml(message)}
        </div>
        <div class="meta" style="display:flex;align-items:center;justify-content:flex-end;gap:2px;">
          <span>${time || ''}</span>${ticks}
        </div>
      `;
      messagesEl.appendChild(msgDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function updateDeleteBtn() {
      const btn = document.getElementById("deleteSelectedBtn");
      if (selectedMessages.size > 0) {
        btn.classList.add("active");
      } else {
        btn.classList.remove("active");
      }
    }

    document.getElementById("deleteSelectedBtn").addEventListener("click", function () {
      if (!currentChatUser || selectedMessages.size === 0) return;
      if (!confirm("Delete selected messages?")) return;
      socket.emit('delete_messages', {
        from: username,
        to: currentChatUser,
        timestamps: Array.from(selectedMessages)
      });
      selectedMessages.clear();
      updateDeleteBtn();
    });

    // Helper to add a message to chat window
    function addMessageToChat(from, message, time, read) {
      const messagesEl = document.getElementById("messages");
      const msgDiv = document.createElement("div");
      const isOutgoing = from === username;
      msgDiv.classList.add("message");
      msgDiv.classList.add(isOutgoing ? "outgoing" : "incoming");
      msgDiv.innerHTML = `
        <div>${escapeHtml(message)}</div>
        <div class="meta">
          ${time || ''}
        </div>
      `;
      messagesEl.appendChild(msgDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // Escape HTML to prevent injection
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Add edit display name (nickname) for others
    function showEditDisplayName(targetUsername, currentDisplayName) {
      const newName = prompt("Enter a custom name for this user (leave blank to reset):", currentDisplayName || "");
      if (newName === null) return;
      fetch('/set_display_name', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ target: targetUsername, display_name: newName })
      })
      .then(res => res.json())
      .then(() => {
        // Refresh user list to reflect new display name
        socket.emit('join', username);
      });
    }

    // Update the sidebar user list
    function updateUserList(users) {
      window.lastUserList = users;
      const userListEl = document.getElementById("userList");
      userListEl.innerHTML = "";

      users.forEach(user => {
        if (user.username === username) return; // skip self

        const userDiv = document.createElement("div");
        userDiv.classList.add("user-item");
        if (user.username === currentChatUser) {
          userDiv.classList.add("active");
        }

        // Avatar
        const avatarDiv = document.createElement("div");
        avatarDiv.classList.add("user-avatar");
        if (user.avatar_url) {
          avatarDiv.innerHTML = `<img src="${user.avatar_url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
        } else {
          avatarDiv.textContent = user.username[0].toUpperCase();
        }

        // Username text
        const nameSpan = document.createElement("span");
        nameSpan.classList.add("user-name");
        nameSpan.textContent = user.nickname || user.username;

        // Edit icon for display name
        const editBtn = document.createElement("button");
        editBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 20 20" fill="none"><path d="M3 17h2.586l9.293-9.293a1 1 0 0 0 0-1.414l-2.172-2.172a1 1 0 0 0-1.414 0L3 13.586V17zm13.707-9.707a3 3 0 0 0 0-4.242l-2.172-2.172a3 3 0 0 0-4.242 0l-1.293 1.293 6.414 6.414 1.293-1.293z" fill="#25d366"/></svg>`;
        editBtn.title = "Set custom name";
        editBtn.style.background = "none";
        editBtn.style.border = "none";
        editBtn.style.cursor = "pointer";
        editBtn.style.marginLeft = "6px";
        editBtn.onclick = (e) => {
          e.stopPropagation();
          showEditDisplayName(user.username, user.nickname);
        };

        // Online status dot
        const onlineDot = document.createElement("div");
        onlineDot.classList.add("online-dot");
        onlineDot.style.backgroundColor = user.online ? "#25d366" : "#777";
        onlineDot.title = user.online ? "Online" : "Offline";

        userDiv.appendChild(avatarDiv);
        userDiv.appendChild(nameSpan);
        userDiv.appendChild(editBtn);
        userDiv.appendChild(onlineDot);

        userDiv.onclick = () => selectChatUser(user.username);

        userListEl.appendChild(userDiv);
      });
    }

    // Select a user to chat with
    function selectChatUser(user) {
      currentChatUser = user;
      document.getElementById("chatWithText").textContent = user;
      // Find user in user list to get avatar_url
      const userObj = Array.from(window.lastUserList || []).find(u => u.username === user);
      const chatAvatar = document.getElementById("chatAvatar");
      const chatAvatarLogo = document.getElementById("chatAvatarLogo");
      if (userObj && userObj.avatar_url) {
        chatAvatarLogo.style.display = "block";
        chatAvatarLogo.innerHTML = `<image href="${userObj.avatar_url}" width="40" height="40" style="border-radius:50%;"/>`;
      } else {
        chatAvatarLogo.style.display = "block";
        chatAvatarLogo.innerHTML = `<circle cx="20" cy="20" r="20" fill="#6bcbef"/><text x="50%" y="55%" text-anchor="middle" fill="#fff" font-size="20" font-family="Arial" dy=".3em">${user[0].toUpperCase()}</text>`;
      }
      document.getElementById("chatInputArea").style.display = "flex";
      clearMessages();
      // Request chat history from server
      socket.emit('get_history', { from: username, to: user });
    }

    // Save last user list for avatar lookup
    function updateUserList(users) {
      window.lastUserList = users;
      const userListEl = document.getElementById("userList");
      userListEl.innerHTML = "";

      users.forEach(user => {
        if (user.username === username) return; // skip self

        const userDiv = document.createElement("div");
        userDiv.classList.add("user-item");
        if (user.username === currentChatUser) {
          userDiv.classList.add("active");
        }

        // Avatar
        const avatarDiv = document.createElement("div");
        avatarDiv.classList.add("user-avatar");
        if (user.avatar_url) {
          avatarDiv.innerHTML = `<img src="${user.avatar_url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
        } else {
          avatarDiv.textContent = user.username[0].toUpperCase();
        }

        // Username text
        const nameSpan = document.createElement("span");
        nameSpan.classList.add("user-name");
        nameSpan.textContent = user.nickname || user.username;

        // Edit icon for display name
        const editBtn = document.createElement("button");
        editBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 20 20" fill="none"><path d="M3 17h2.586l9.293-9.293a1 1 0 0 0 0-1.414l-2.172-2.172a1 1 0 0 0-1.414 0L3 13.586V17zm13.707-9.707a3 3 0 0 0 0-4.242l-2.172-2.172a3 3 0 0 0-4.242 0l-1.293 1.293 6.414 6.414 1.293-1.293z" fill="#25d366"/></svg>`;
        editBtn.title = "Set custom name";
        editBtn.style.background = "none";
        editBtn.style.border = "none";
        editBtn.style.cursor = "pointer";
        editBtn.style.marginLeft = "6px";
        editBtn.onclick = (e) => {
          e.stopPropagation();
          showEditDisplayName(user.username, user.nickname);
        };

        // Online status dot
        const onlineDot = document.createElement("div");
        onlineDot.classList.add("online-dot");
        onlineDot.style.backgroundColor = user.online ? "#25d366" : "#777";
        onlineDot.title = user.online ? "Online" : "Offline";

        userDiv.appendChild(avatarDiv);
        userDiv.appendChild(nameSpan);
        userDiv.appendChild(editBtn);
        userDiv.appendChild(onlineDot);

        userDiv.onclick = () => selectChatUser(user.username);

        userListEl.appendChild(userDiv);
      });
    }

    // Clear chat messages area
    function clearMessages() {
      document.getElementById("messages").innerHTML = "";
    }

    // Receive chat history from server
    socket.on('chat_history', history => {
      clearMessages();
      selectedMessages.clear();
      updateDeleteBtn();
      history.forEach(msg => {
        // For outgoing messages, pass msg.read; for incoming, always true (no ticks)
        addMessageToChat(msg.from, msg.message, msg.time, msg.from === username ? msg.read : true);
      });
    });

    // Send message handler
    function sendMessage() {
      const input = document.getElementById("messageInput");
      const text = input.value.trim();
      if (!text || !currentChatUser) return;

      socket.emit('private_message', {
        from: username,
        to: currentChatUser,
        message: text
      });
      input.value = "";
      input.focus();
    }

    // Send on Enter key
    document.getElementById("messageInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        sendMessage();
      }
    });

    // Send button click
    document.getElementById("sendButton").addEventListener("click", sendMessage);

    // Profile modal logic
    const myAvatar = document.getElementById("myAvatar");
    const profileBtn = document.getElementById("profileBtn");
    const profileModal = document.getElementById("profileModal");
    const closeProfile = document.getElementById("closeProfile");
    const profileAvatarImg = document.getElementById("profileAvatarImg");
    const avatarInput = document.getElementById("avatarInput");
    const profileUsername = document.getElementById("profileUsername");
    const profileEmail = document.getElementById("profileEmail");
    const profileFullName = document.getElementById("profileFullName");
    const profileMobile = document.getElementById("profileMobile");
    const profileLastSeen = document.getElementById("profileLastSeen");
    const profileOnline = document.getElementById("profileOnline");

    // Fetch profile info from backend
    function loadProfile() {
      fetch('/profile')
        .then(res => res.json())
        .then(user => {
          profileUsername.textContent = user.username;
          profileEmail.textContent = user.email ? "Email: " + user.email : "";
          profileFullName.textContent = user.name ? "Full Name: " + user.name : "";
          profileMobile.textContent = user.mobile ? "Mobile: " + user.mobile : "";
          profileNickname.textContent = user.nickname ? "Nickname: " + user.nickname : "";
          profileLastSeen.textContent = user.last_seen ? "Last seen: " + user.last_seen : "";
          profileOnline.textContent = typeof user.online === "boolean" ? ("Online: " + (user.online ? "Yes" : "No")) : "";
          if (user.avatar_url) {
            profileAvatarImg.src = user.avatar_url;
            myAvatar.innerHTML = `<img src="${user.avatar_url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
          } else {
            profileAvatarImg.src = "";
            myAvatar.textContent = user.username[0].toUpperCase();
          }
        });
    }

    profileBtn.addEventListener("click", () => {
      loadProfile();
      profileModal.style.display = "flex";
    });
    closeProfile.addEventListener("click", () => {
      profileModal.style.display = "none";
    });

    // Avatar upload
    avatarInput.addEventListener("change", function() {
      const file = avatarInput.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append("avatar", file);
      fetch("/upload_avatar", { method: "POST", body: formData })
        .then(res => res.json())
        .then(data => {
          if (data.avatar_url) {
            profileAvatarImg.src = data.avatar_url;
            myAvatar.innerHTML = `<img src="${data.avatar_url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
          }
        });
    });

    // Three dots menu logic
    const chatMenuBtn = document.getElementById("chatMenuBtn");
    const chatMenuDropdown = document.getElementById("chatMenuDropdown");
    const deleteAllBtn = document.getElementById("deleteAllBtn");
    const showRepProfileBtn = document.getElementById("showRepProfileBtn");

    chatMenuBtn.addEventListener("click", function(e) {
      e.stopPropagation();
      chatMenuDropdown.style.display = chatMenuDropdown.style.display === "block" ? "none" : "block";
    });

    // Hide menu when clicking outside
    document.addEventListener("click", function(e) {
      chatMenuDropdown.style.display = "none";
    });

    // Prevent menu from closing when clicking inside
    chatMenuDropdown.addEventListener("click", function(e) {
      e.stopPropagation();
    });

    // Delete all messages function
    deleteAllBtn.addEventListener("click", function() {
      if (!currentChatUser) return;
      if (!confirm("Delete all messages in this chat?")) return;
      socket.emit('delete_messages', {
        from: username,
        to: currentChatUser,
        timestamps: getAllMessageTimestamps()
      });
      chatMenuDropdown.style.display = "none";
    });

    // Show representative profile function
    showRepProfileBtn.addEventListener("click", function() {
      if (!currentChatUser) return;
      showOtherProfile(currentChatUser);
      chatMenuDropdown.style.display = "none";
    });

    // Helper to get all timestamps of messages in this chat (both incoming and outgoing)
    function getAllMessageTimestamps() {
      const messages = document.querySelectorAll("#messages .message");
      return Array.from(messages).map(msg => msg.dataset.time).filter(Boolean);
    }

    // Show other user's profile modal
    function showOtherProfile(username) {
      fetch(`/user_profile/${encodeURIComponent(username)}`)
        .then(res => res.json())
        .then(user => {
          if (user.error) return;
          profileUsername.textContent = user.username;
          profileEmail.textContent = user.email ? "Email: " + user.email : "";
          profileFullName.textContent = user.name ? "Full Name: " + user.name : "";
          profileMobile.textContent = user.mobile ? "Mobile: " + user.mobile : "";
          profileNickname.textContent = user.nickname ? "Nickname: " + user.nickname : "";
          profileLastSeen.textContent = user.last_seen ? "Last seen: " + user.last_seen : "";
          profileOnline.textContent = typeof user.online === "boolean" ? ("Online: " + (user.online ? "Yes" : "No")) : "";
          if (user.avatar_url) {
            profileAvatarImg.src = user.avatar_url;
            profileAvatarImg.style.display = "";
            profileAvatarImg.style.objectFit = "cover";
            profileAvatarImg.style.objectPosition = "center";
            profileAvatarImg.style.width = "180px";
            profileAvatarImg.style.height = "180px";
            profileAvatarImg.style.borderRadius = "50%";
            profileAvatarImg.style.background = "#6bcbef";
            profileAvatarImg.style.border = "6px solid #25d366";
            profileAvatarImg.style.boxShadow = "0 4px 32px #0006";
          } else {
            profileAvatarImg.src = "";
            profileAvatarImg.style.display = "none";
          }
          // Hide avatar upload for others
          avatarInput.parentElement.style.display = "none";
          profileModal.style.display = "flex";
        });
    }

    // When closing profile modal, re-enable own profile editing and show avatar upload
    closeProfile.addEventListener("click", () => {
      profileModal.style.display = "none";
      avatarInput.parentElement.style.display = "";
    });

    // Media sharing logic
    const mediaInput = document.getElementById("mediaInput");
    const mediaButton = document.getElementById("mediaButton");

    mediaButton.addEventListener("click", () => {
      mediaInput.click();
    });

    mediaInput.addEventListener("change", function() {
      const file = mediaInput.files[0];
      if (!file || !currentChatUser) return;
      const formData = new FormData();
      formData.append("media", file);
      fetch("/upload_media", { method: "POST", body: formData })
        .then(res => res.json())
        .then(data => {
          if (data.media_url) {
            let media_type = "file";
            if (file.type.startsWith("image/")) media_type = "image";
            else if (file.type.startsWith("video/")) media_type = "video";
            else if (file.type.startsWith("audio/")) media_type = "audio";
            const caption = prompt("Add a caption (optional):", "");
            socket.emit('media_message', {
              from: username,
              to: currentChatUser,
              media_url: data.media_url,
              media_type,
              caption: caption || ""
            });
          }
        });
      mediaInput.value = "";
    });

    // Listen for incoming media messages
    socket.on('media_message', data => {
      if (data.from === currentChatUser || data.from === username || data.to === currentChatUser) {
        addMediaMessageToChat(data.from, data.media_url, data.media_type, data.caption, data.time, data.read);
      }
    });

    function addMediaMessageToChat(from, media_url, media_type, caption, time, read) {
      const messagesEl = document.getElementById("messages");
      const msgDiv = document.createElement("div");
      const isOutgoing = from === username;
      msgDiv.classList.add("message");
      msgDiv.classList.add(isOutgoing ? "outgoing" : "incoming");
      let mediaHtml = "";
      if (media_type === "image") {
        mediaHtml = `<img src="${media_url}" alt="image" style="max-width:220px;max-height:180px;border-radius:8px;display:block;margin-bottom:6px;border:1px solid #333;">`;
      } else if (media_type === "video") {
        mediaHtml = `<video src="${media_url}" controls style="max-width:220px;max-height:180px;border-radius:8px;display:block;margin-bottom:6px;border:1px solid #333;"></video>`;
      } else if (media_type === "audio") {
        mediaHtml = `<audio src="${media_url}" controls style="width:200px;display:block;margin-bottom:6px;"></audio>`;
      } else {
        // generic file
        mediaHtml = `<a href="${media_url}" target="_blank" style="color:#25d366;word-break:break-all;">Download file</a>`;
      }
      // Ticks for outgoing messages
      let ticks = "";
      if (isOutgoing) {
        if (read) {
          ticks = `<span class="msg-ticks" style="float:right;margin-left:8px;">
            <svg width="18" height="14" viewBox="0 0 18 14" style="vertical-align:middle;"><polyline points="1 7 7 13 17 3" fill="none" stroke="#6bcbef" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><polyline points="5 7 11 13 17 7" fill="none" stroke="#6bcbef" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>`;
        } else {
          ticks = `<span class="msg-ticks" style="float:right;margin-left:8px;">
            <svg width="18" height="14" viewBox="0 0 18 14" style="vertical-align:middle;"><polyline points="1 7 7 13 17 3" fill="none" stroke="#b6b9bb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><polyline points="5 7 11 13 17 7" fill="none" stroke="#b6b9bb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>`;
        }
      }
      msgDiv.innerHTML = `
        <div style="position:relative;">
          ${mediaHtml}
          ${caption ? `<div style="margin-bottom:4px;">${escapeHtml(caption)}</div>` : ""}
        </div>
        <div class="meta" style="display:flex;align-items:center;justify-content:flex-end;gap:2px;">
          <span>${time || ''}</span>${ticks}
        </div>
      `;
      messagesEl.appendChild(msgDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // Status list logic (WhatsApp-like)
    const statusList = document.getElementById("statusList");
    function fetchStatuses() {
      fetch("/get_statuses")
        .then(res => res.json())
        .then(statuses => {
          statusList.innerHTML = "";
          statuses.forEach(status => {
            if (!status.status_url) return;
            const item = document.createElement("div");
            item.className = "status-list-item";
            item.onclick = () => showStatusOfUser(status.username);

            const avatar = document.createElement("img");
            avatar.className = "status-list-avatar";
            avatar.src = status.avatar_url || "";
            avatar.alt = status.nickname || status.username;

            const nick = document.createElement("span");
            nick.className = "status-list-nickname";
            nick.textContent = status.nickname || status.username;

            const time = document.createElement("span");
            time.className = "status-list-time";
            time.textContent = status.timestamp ? new Date(status.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "";

            item.appendChild(avatar);
            item.appendChild(nick);
            item.appendChild(time);
            statusList.appendChild(item);
          });
        });
    }
    fetchStatuses();
    setInterval(fetchStatuses, 20000);

    // Show any user's status in the status slide
    function showStatusOfUser(username) {
      fetch(`/get_status/${encodeURIComponent(username)}`)
        .then(res => res.json())
        .then(status => {
          statusAvatar.src = status.avatar_url || "";
          statusText.textContent = status.status_text || status.nickname || status.username;
          statusTime.textContent = status.timestamp ? "Updated: " + new Date(status.timestamp).toLocaleString() : "";
          if (status.status_url && status.media_type === "image") {
            statusMedia.src = status.status_url;
            statusMedia.style.display = "block";
            statusMedia.type = "image";
            if (statusMedia.tagName !== "IMG") {
              statusMedia.outerHTML = `<img id="statusMedia" src="${status.status_url}" alt="Status Media" style="max-width:320px;max-height:320px;border-radius:16px;margin-bottom:18px;display:block;background:#111b21;border:2px solid #25d366;">`;
            }
          } else if (status.status_url && status.media_type === "video") {
            statusMedia.outerHTML = `<video id="statusMedia" src="${status.status_url}" controls style="max-width:320px;max-height:320px;border-radius:16px;margin-bottom:18px;display:block;background:#111b21;border:2px solid #25d366;"></video>`;
          } else {
            statusMedia.src = "";
            statusMedia.style.display = "none";
          }
          statusUploadForm.style.display = "none";
          statusSlide.style.display = "flex";
        });
    }

    // Upload status handler
    statusUploadForm.addEventListener("submit", function(e) {
      e.preventDefault();
      const file = statusMediaInput.files[0];
      const text = statusTextInput.value.trim();
      const formData = new FormData();
      if (file) formData.append("status_media", file);
      formData.append("status_text", text);
      fetch("/upload_status", { method: "POST", body: formData })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            statusUploadForm.style.display = "none";
            statusSlide.style.display = "none";
            statusMediaInput.value = "";
            statusTextInput.value = "";
            fetchStatuses();
          }
        });
    });

    closeStatusSlide.addEventListener("click", function() {
      statusSlide.style.display = "none";
      statusUploadForm.style.display = "none";
      statusMediaInput.value = "";
      statusTextInput.value = "";
    });

    // WhatsApp-like status viewer slide logic
    const statusViewerSlide = document.getElementById("statusViewerSlide");
    const closeStatusViewerSlide = document.getElementById("closeStatusViewerSlide");
    const statusViewerAvatar = document.getElementById("statusViewerAvatar");
    const statusViewerNickname = document.getElementById("statusViewerNickname");
    const statusViewerMedia = document.getElementById("statusViewerMedia");
    const statusViewerVideo = document.getElementById("statusViewerVideo");
    const statusViewerText = document.getElementById("statusViewerText");
    const statusViewerTime = document.getElementById("statusViewerTime");
    // Remove arrow buttons
    // const prevStatusBtn = document.getElementById("prevStatusBtn");
    // const nextStatusBtn = document.getElementById("nextStatusBtn");
    const statusViewerPrevArea = document.getElementById("statusViewerPrevArea");
    const statusViewerNextArea = document.getElementById("statusViewerNextArea");

    let allStatuses = [];
    let currentStatusIndex = 0;

    function openStatusViewer(index) {
      if (!allStatuses.length) return;
      currentStatusIndex = index;
      const status = allStatuses[currentStatusIndex];
      statusViewerAvatar.src = status.avatar_url || "";
      statusViewerNickname.textContent = status.nickname || status.username;
      statusViewerText.textContent = status.status_text || "";
      statusViewerTime.textContent = status.timestamp ? "Updated: " + new Date(status.timestamp).toLocaleString() : "";
      if (status.status_url && status.media_type === "image") {
        statusViewerMedia.src = status.status_url;
        statusViewerMedia.style.display = "block";
        statusViewerVideo.style.display = "none";
      } else if (status.status_url && status.media_type === "video") {
        statusViewerVideo.src = status.status_url;
        statusViewerVideo.style.display = "block";
        statusViewerMedia.style.display = "none";
      } else {
        statusViewerMedia.src = "";
        statusViewerMedia.style.display = "none";
        statusViewerVideo.src = "";
        statusViewerVideo.style.display = "none";
      }
      statusViewerSlide.style.display = "flex";
    }

    function fetchAndShowStatuses(startIndex = 0) {
      fetch("/get_statuses")
        .then(res => res.json())
        .then(statuses => {
          allStatuses = statuses.filter(s => s.status_url);
          if (allStatuses.length) {
            openStatusViewer(startIndex);
          }
        });
    }

    // Show status viewer when clicking a status in the list
    statusList.addEventListener("click", function(e) {
      const items = Array.from(statusList.getElementsByClassName("status-list-item"));
      const clicked = items.indexOf(e.target.closest(".status-list-item"));
      if (clicked !== -1) {
        fetchAndShowStatuses(clicked);
      }
    });

    // WhatsApp-like: change status by clicking left/right side
    statusViewerPrevArea.onclick = function(e) {
      if (allStatuses.length) {
        currentStatusIndex = (currentStatusIndex - 1 + allStatuses.length) % allStatuses.length;
        openStatusViewer(currentStatusIndex);
      }
    };
    statusViewerNextArea.onclick = function(e) {
      if (allStatuses.length) {
        currentStatusIndex = (currentStatusIndex + 1) % allStatuses.length;
        openStatusViewer(currentStatusIndex);
      }
    };

    closeStatusViewerSlide.addEventListener("click", function() {
      statusViewerSlide.style.display = "none";
      statusViewerMedia.src = "";
      statusViewerVideo.src = "";
    });

    // Show profile avatar in left corner (sidebar)
    function setMyAvatar(avatarUrl, username) {
      const myAvatar = document.getElementById("myAvatar");
      if (avatarUrl) {
        myAvatar.innerHTML = `<img src="${avatarUrl}" alt="avatar" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
      } else {
        myAvatar.textContent = username[0].toUpperCase();
      }
    }
    // Fetch profile info for avatar on load and after avatar upload
    function refreshMyAvatar() {
      fetch('/profile')
        .then(res => res.json())
        .then(user => {
          setMyAvatar(user.avatar_url, user.username);
        });
    }
    refreshMyAvatar();

    // Status slide panel logic
    const mainContainer = document.getElementById("mainContainer");
    const openStatusPanelBtn = document.getElementById("openStatusPanelBtn");
    const closeStatusPanelBtn = document.getElementById("closeStatusSlidePanelBtn");
    const statusListPanel = document.getElementById("statusListPanel");
    const statusUploadFormPanel = document.getElementById("statusUploadFormPanel");
    const statusMediaInputPanel = document.getElementById("statusMediaInputPanel");
    const statusTextInputPanel = document.getElementById("statusTextInputPanel");

    openStatusPanelBtn.addEventListener("click", function() {
      mainContainer.classList.add("slide-status");
      fetchStatusesPanel();
    });
    closeStatusPanelBtn.addEventListener("click", function() {
      mainContainer.classList.remove("slide-status");
    });

    function fetchStatusesPanel() {
      fetch("/get_statuses")
        .then(res => res.json())
        .then(statuses => {
          statusListPanel.innerHTML = "";
          statuses.forEach(status => {
            if (!status.status_url && !status.status_text) return;
            const item = document.createElement("div");
            item.className = "status-list-item";
            item.onclick = () => showStatusOfUser(status.username);

            const avatar = document.createElement("img");
            avatar.className = "status-list-avatar";
            avatar.src = status.avatar_url || "";
            avatar.alt = status.nickname || status.username;

            const nick = document.createElement("span");
            nick.className = "status-list-nickname";
            nick.textContent = status.nickname || status.username;

            const time = document.createElement("span");
            time.className = "status-list-time";
            time.textContent = status.timestamp ? new Date(status.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "";

            item.appendChild(avatar);
            item.appendChild(nick);
            item.appendChild(time);
            statusListPanel.appendChild(item);
          });
        });
    }

    // Upload status from panel
    statusUploadFormPanel.addEventListener("submit", function(e) {
      e.preventDefault();
      const file = statusMediaInputPanel.files[0];
      const text = statusTextInputPanel.value.trim();
      const formData = new FormData();
      if (file) formData.append("status_media", file);
      formData.append("status_text", text);
      fetch("/upload_status", { method: "POST", body: formData })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            statusUploadFormPanel.reset();
            fetchStatusesPanel();
          } else {
            alert(data.error || "Failed to upload status.");
          }
        });
    });

    // Fix: update avatar in sidebar after avatar upload
    avatarInput.addEventListener("change", function() {
      const file = avatarInput.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append("avatar", file);
      fetch("/upload_avatar", { method: "POST", body: formData })
        .then(res => res.json())
        .then(data => {
          if (data.avatar_url) {
            profileAvatarImg.src = data.avatar_url;
            refreshMyAvatar();
          }
        });
    });
    // Status Slide Panel logic
    const statusSlidePanel = document.getElementById("statusSlidePanel");
    const closeStatusSlidePanelBtn = document.getElementById("closeStatusSlidePanelBtn");
    // Add a button to open the status slide (for demo, use keyboard shortcut 's')
    document.addEventListener("keydown", function(e) {
      if (e.key === "s" && !statusSlidePanel.classList.contains("active")) {
        openStatusSlidePanel();
      }
    });
    function openStatusSlidePanel() {
      statusSlidePanel.classList.add("active");
      fetchStatusSlideData();
    }
    closeStatusSlidePanelBtn.onclick = function() {
      statusSlidePanel.classList.remove("active");
    };

    // Fetch and render statuses for the slide
    let slideMyStatus = null;
    let slideStatuses = [];
    function fetchStatusSlideData() {
      fetch("/get_statuses")
        .then(res => res.json())
        .then(statuses => {
          const username = "{{ username }}";
          slideMyStatus = null;
          slideStatuses = [];
          statuses.forEach(s => {
            if (s.username === username) slideMyStatus = s;
            else slideStatuses.push(s);
          });
          slideStatuses.sort((a, b) => (b.timestamp || "").localeCompare(a.timestamp || ""));
          renderStatusSlide();
        });
    }
    function renderStatusSlide() {
      // My status
      const myList = document.getElementById("statusSlideMyList");
      myList.innerHTML = "";
      if (slideMyStatus && (slideMyStatus.status_url || slideMyStatus.status_text)) {
        const item = document.createElement("div");
        item.className = "status-slide-list-item";
        item.onclick = () => openStatusSlideViewer(0, true);

        const avatar = document.createElement("img");
        avatar.className = "status-slide-list-avatar";
        avatar.src = slideMyStatus.avatar_url || "";
        avatar.alt = slideMyStatus.nickname || slideMyStatus.username;

        const nick = document.createElement("span");
        nick.className = "status-slide-list-nickname";
        nick.textContent = slideMyStatus.nickname || slideMyStatus.username;

        const time = document.createElement("span");
        time.className = "status-slide-list-time";
        time.textContent = slideMyStatus.timestamp ? new Date(slideMyStatus.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "";

        item.appendChild(avatar);
        item.appendChild(nick);
        item.appendChild(time);
        myList.appendChild(item);
      }
      // Others
      const list = document.getElementById("statusSlideList");
      list.innerHTML = "";
      slideStatuses.forEach((status, idx) => {
        if (!status.status_url && !status.status_text) return;
        const item = document.createElement("div");
        item.className = "status-slide-list-item";
        item.onclick = () => openStatusSlideViewer(idx, false);

        const avatar = document.createElement("img");
        avatar.className = "status-slide-list-avatar";
        avatar.src = status.avatar_url || "";
        avatar.alt = status.nickname || status.username;

        const nick = document.createElement("span");
        nick.className = "status-slide-list-nickname";
        nick.textContent = status.nickname || status.username;

        const time = document.createElement("span");
        time.className = "status-slide-list-time";
        time.textContent = status.timestamp ? new Date(status.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "";

        item.appendChild(avatar);
        item.appendChild(nick);
        item.appendChild(time);
        list.appendChild(item);
      });
    }
    // Status viewer in slide
    let slideCurrentStatusIndex = 0;
    let slideCurrentList = [];
    function openStatusSlideViewer(idx, isMine) {
      slideCurrentStatusIndex = idx;
      slideCurrentList = isMine ? [slideMyStatus] : slideStatuses;
      const status = slideCurrentList[slideCurrentStatusIndex];
      document.getElementById("statusSlideViewer").classList.add("active");
      document.getElementById("statusSlideViewerNickname").textContent = status.nickname || status.username;
      document.getElementById("statusSlideViewerText").textContent = status.status_text || "";
      document.getElementById("statusSlideViewerTime").textContent = status.timestamp ? "Updated: " + new Date(status.timestamp).toLocaleString() : "";
      const media = document.getElementById("statusSlideViewerMedia");
      const video = document.getElementById("statusSlideViewerVideo");
      if (status.status_url && status.media_type === "image") {
        media.src = status.status_url;
        media.style.display = "block";
        video.style.display = "none";
      } else if (status.status_url && status.media_type === "video") {
        video.src = status.status_url;
        video.style.display = "block";
        media.style.display = "none";
      } else {
        media.src = "";
        media.style.display = "none";
        video.src = "";
        video.style.display = "none";
      }
    }
    document.getElementById("statusSlidePrevBtn").onclick = function() {
      if (slideCurrentList.length > 0) {
        slideCurrentStatusIndex = (slideCurrentStatusIndex - 1 + slideCurrentList.length) % slideCurrentList.length;
        openStatusSlideViewer(slideCurrentStatusIndex, slideCurrentList === [slideMyStatus]);
      }
    };
    document.getElementById("statusSlideNextBtn").onclick = function() {
      if (slideCurrentList.length > 0) {
        slideCurrentStatusIndex = (slideCurrentStatusIndex + 1) % slideCurrentList.length;
        openStatusSlideViewer(slideCurrentStatusIndex, slideCurrentList === [slideMyStatus]);
      }
    };
    // Hide viewer when clicking outside
    document.body.addEventListener("click", function(e) {
      if (!document.getElementById("statusSlideViewer").contains(e.target) && !e.target.classList.contains("status-slide-list-item")) {
        document.getElementById("statusSlideViewer").classList.remove("active");
      }
    });
    // Optionally, add a button in chat header to open the status slide
    // Example: <button id="openStatusSlideBtn">Status</button>
    // document.getElementById("openStatusSlideBtn").onclick = openStatusSlidePanel;
  </script>
</body>
</html>
